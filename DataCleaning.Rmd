---
title: "Visualizations"
output:
  html_document: default
  pdf_document: default
---


```{r load-data, echo = FALSE} 
library(readr)
library(tidyverse)
library(forcats)
library(kableExtra)
library(sf)
library(leaflet)
install.packages("naniar")
library(naniar)

devtools::install_github("rstudio/leaflet.providers")

  
district_demographics <- read_csv("https://raw.githubusercontent.com/invinst/chicago-police-data/master/data/context_data/district_demographics/Districts.csv")

active_duty_officers <- read_csv("https://raw.githubusercontent.com/invinst/chicago-police-data/master/data/context_data/CPD%20Employees%20active-duty-only.csv")

#The officers accused
complaints_accused <- read_csv("data/complaints-accused_2000-2016_2016-11.csv")

#those who made the complaints
complainants <- read_csv("data/complaints-complainants_2000-2016_2016-11 (1).csv")

#What complaints were made (more categorical data)
complaints_made <- read_csv("data/complaints-complaints_2000-2016_2016-11 (1).csv")

units <- read.csv("https://raw.githubusercontent.com/invinst/chicago-police-data/master/data/context_data/current_and_past_units/Current_and_Past_CPD_Units_2016-05-06.csv")
```


```{r data-joins, fig.alt = "Scatterplot of police complaints per capita by district name colored by racial majority. Visualization shows "}
district_complaints <- complaints_accused %>%
  filter(current_unit %in% 1:25) %>%
  group_by(current_unit) %>%
  summarise(n = n()) %>%
  arrange(desc(n))

total_district_complaints <- full_join(district_complaints,
                                       district_demographics,
                                       by = c("current_unit" = "District_No")) %>%
  mutate(complaints_per_capita = n/Population)

total_district_complaints %>%
  filter(is.na(District_Name) == FALSE) %>%
         ggplot(mapping = aes(
                  x = fct_reorder(District_Name, complaints_per_capita),
                  y = complaints_per_capita, 
                color = Majority)) +
  geom_point() +
  geom_segment(aes(x = fct_reorder(District_Name, complaints_per_capita), 
                   xend = fct_reorder(District_Name, complaints_per_capita), 
                   y = 0, yend = complaints_per_capita)) +
  coord_flip() +
  labs(title = "Complaints per Capita by District Name",
       subtitle = "Colored by Racial Majority",
       x = "District Name",
       y = "Complaints Per Capita")
```
  
```{r proportion-findings-vis}
district_complaints_1 <- complaints_accused %>%
  filter(current_unit %in% 1:25) %>%
  group_by(current_unit)

total_district_complaints_findings <- full_join(district_complaints_1,
                                       district_demographics,
                                       by = c("current_unit" = "District_No"))

#stat = "identity"

data1 <- total_district_complaints_findings %>%
  mutate(final_decision = as.factor(case_when(
    final_finding %in% "SU" ~ "Sustained",
    final_finding %in% "DIS" ~ "Sustained",
    is.na(final_finding) == TRUE ~ "Missing",
    final_finding %in% "NAF" ~ "No Affidavit or Cooperation",
    final_finding %in% "NC" ~ "No Affidavit or Cooperation",
    final_finding %in% "NS" ~ "Not Sustained",
    final_finding %in% "EX" ~ "Not Sustained",
    final_finding %in% "UN" ~ "Not Sustained")
  )) %>%
  group_by(final_decision, District_Name)  %>%
  summarize(n = n())

data1 %>%
  group_by(final_decision) %>%
  summarize(n = n())

#reorder so that missing is at the end and change colors, take out the NA
 ggplot(data = data1,  aes(fill = factor(final_decision, levels = c("Missing", "Not Sustained", "No Affidavit or Cooperation", "Sustained")),
                           x = fct_relevel(District_Name), district_levels,
                           y = n)) +
  geom_bar(position = "fill", stat = "identity") +
  theme_minimal() +
  scale_fill_viridis_d() +
  coord_flip() +
   labs(title = "Proportion of Final Findings",
        subtitle = "By District",
        x = "District Name",
        y = "Proportion of Complaints",
        fill = "Final Decision"
        ) 

```
  
```{r complaints for sustained decisions}

sustained_data <- total_district_complaints_findings %>%
  group_by(final_finding, District_Name, Majority, Population) %>%
  filter(final_finding == "SU") %>%
  summarize(n = n()) %>%
  mutate(complaints_per_capita = n/Population) 
  

  ggplot(data = sustained_data, 
                mapping = aes(
                  x = fct_reorder(District_Name, complaints_per_capita),
                  y = complaints_per_capita, 
                color = Majority)) +
  geom_point() +
  coord_flip() +
  labs(title = " Sustained Complaints per Capita by District Name",
       subtitle = "Colored by Racial Majority",
       x = "District Name",
       y = " Sustained Complaints Per Capita")
```
  
```{r complaints for no cooperation/affidavit decisions}

no_ca_data <- total_district_complaints_findings %>%
  group_by(final_finding, District_Name, Majority, Population) %>%
  filter(final_finding == "NAF") %>%
  summarize(n = n()) %>%
  mutate(complaints_per_capita = n/Population) 
  

  ggplot(data = no_ca_data, 
                mapping = aes(
                  x = fct_reorder(District_Name, complaints_per_capita),
                  y = complaints_per_capita, 
                color = Majority)) +
  geom_point() +
  coord_flip() +
  labs(title = " Sustained Complaints per Capita by District Name",
       subtitle = "Colored by Racial Majority",
       x = "District Name",
       y = " Sustained Complaints Per Capita")
```
  
```{r stats about demographics}

#The districts of which demogrpahic majoirty compromise most of the data?

total_district_complaints_findings %>%
  group_by(Majority) %>%
  summarise(n = n(), prop_of_data = n/71960)
```
  
```{r complaints for missing data}
missing_data <- total_district_complaints_findings %>%
  group_by(final_finding, District_Name, Majority, Population) %>%
  filter(is.na(final_finding)) %>%
  filter(!is.na(District_Name)) %>%
  summarize(n = n()) %>%
  mutate(complaints_per_capita = n/Population) 
  
 ggplot(data = missing_data, 
                mapping = aes(
                  x = fct_reorder(District_Name, complaints_per_capita),
                  y = complaints_per_capita, 
                color = Majority)) +
  geom_point() +
  coord_flip() +
  labs(title = " Missing Complaints per Capita by District Name",
       subtitle = "Colored by Racial Majority",
       x = "District Name",
       y = " Missing Complaints Per Capita")
```
  
