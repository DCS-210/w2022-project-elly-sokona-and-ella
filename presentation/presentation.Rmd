---
title: "Police Complaints in Chicago"
subtitle: "Presentation subtitle (if any)"
author: "Elly Beckerman, Sokona Mangane"
institute: "Bates College"
date: "`r Sys.Date()`"
output:
  xaringan::moon_reader:
    css: xaringan-themer2.css
    lib_dir: libs
    nature:
      ratio: "16:9"
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---

```{r load-packages, include = FALSE}
# Add any additional packages you need to this chunk
library(tidyverse)
library(tidymodels)
library(palmerpenguins)
library(knitr)
library(xaringanthemer)
```

```{r setup, include=FALSE}
# For better figure resolution
knitr::opts_chunk$set(fig.retina = 3, dpi = 300, fig.width = 6, fig.asp = 0.618, out.width = "90%", warning = FALSE, message = FALSE, echo = FALSE)
```

```{r load our packages, include = FALSE}
library(knitr)
library(tidyverse)
library(readr)
library(tidyverse)
library(forcats)
library(kableExtra)
library(sf)
library(leaflet)
library(leafsync)
#install.packages("naniar")
library(naniar)
# set default options
#devtools::install_github("thomasp85/patchwork")
library(patchwork)

```

```{r Reading in the data, echo=FALSE, message=FALSE, warning = FALSE}

district_demographics <- read_csv("https://raw.githubusercontent.com/invinst/chicago-police-data/master/data/context_data/district_demographics/Districts.csv")

active_duty_officers <- read_csv("https://raw.githubusercontent.com/invinst/chicago-police-data/master/data/context_data/CPD%20Employees%20active-duty-only.csv")

#The officers accused
complaints_accused <- read_csv("../data/complaints-accused_2000-2016_2016-11.csv")

#those who made the complaints
complainants <- read_csv("../data/complaints-complainants_2000-2016_2016-11 (1).csv")

#What complaints were made (more categorical data)
complaints_made <- read_csv("../data/complaints-complaints_2000-2016_2016-11 (1).csv")

units <- read.csv("https://raw.githubusercontent.com/invinst/chicago-police-data/master/data/context_data/current_and_past_units/Current_and_Past_CPD_Units_2016-05-06.csv")

```


```{r background-image, include = FALSE}
style_xaringan(
  title_slide_background_image = "img/web-chicago-skyline.webp",
  title_slide_text_color = "#000000")
```

---

# Background image
.opacity[
```{r background image}
knitr::include_graphics("img/web-chicago-skyline.webp")
```
]

---

# Introduction
- The data set is extensive and includes information about complaints against Chicago police officers from 1988 to 2018.

--

-  Our data was collected by the Invisible Institute, an investigative journalism company as part of their Citizen Police Data Project.

--

- The Invisible Institute sued the city of Chicago for the release of complaint records against the Chicago Police Department.

--

- The files were released in 2016, revealing over 100,000 complaint records to the public.

--

- why chicago stuff

---
# Our Research Questions
- What are the racial makeups of different neighborhoods in Chicago? 

--

- In which neighborhoods are there the most police complaints per capita?

--

- What are the outcomes of police complaints in these neighborhoods?

---
class: center, inverse, middle

# What are the racial makeups of different neighborhoods in Chicago? 
  
---

# Racial makeup of Chicago neighborhoods

``` {r leaflet-demographics, fig.alt = "Leaflet Maps of the Percentage of Black, white, and Latino residents by neighborhood. Maps are very segregated", echo = FALSE, fig.width = 10, out.width = "150%"}
district_complaints <- complaints_accused %>%
  filter(current_unit %in% 1:25) %>%
  group_by(current_unit) %>%
  summarise(n = n()) %>%
  arrange(desc(n))

total_district_complaints <- full_join(district_complaints,
                                       district_demographics,
                                       by = c("current_unit" = "District_No")) %>%
  mutate(complaints_per_capita = n/Population)

chicago_police_district_spatial <- st_read(dsn = "/cloud/project/data/geo_export_2efb16ec-aa66-49b0-92a0-2d6f5e0f81d9.shp")

total_district_complaints_spatial <- total_district_complaints %>%
  mutate(`Latino%` = str_remove(`Latino%`, "%"),
         `White%` = str_remove(`White%`, "%"),
         `Black%` = str_remove(`Black%`, "%"),
         `Asian%` = str_remove(`Asian%`, "%"),
         `Native_American%` = str_remove(`Native_American%`, "%"),
         `Other%` = str_remove(`Other%`, "%"),
         `Latino%` = as.numeric(`Latino%`),
         `White%` = as.numeric(`White%`),
         `Black%` = as.numeric(`Black%`),
         `Asian%` = as.numeric(`Asian%`),
         `Native_American%` = as.numeric(`Native_American%`),
         `Other%` = as.numeric(`Other%`)) %>%
  mutate(current_unit = as.character(current_unit))%>%
  left_join(chicago_police_district_spatial,
                                    by = c("current_unit" = "dist_num")) %>%
  st_as_sf() %>%
  st_transform("+init=epsg:4326")

bins <- seq(from = 0, to = 100, by = 12.5)
pal_perc <- colorBin("OrRd", domain = total_district_complaints_spatial , bins = bins)

m <- leaflet(total_district_complaints_spatial) %>%
  addTiles() %>%
  setView(-87.633506, 41.876067, zoom = 9.5) %>%
  addProviderTiles(providers$CartoDB.Positron)

Black_perc_m <- m %>%
  addPolygons(
    fillOpacity = 1,
    color = "black",
    opacity = 0.7,
    weight = 1,
    fillColor = ~pal_perc(total_district_complaints_spatial$`Black%`),
    highlightOptions = highlightOptions(
    weight = 5,
    color = "#666",
    fillOpacity = 0.7,
    bringToFront = FALSE))
Black_perc_m <- Black_perc_m %>%
  addLegend(
    position = "topright",
    pal = pal_perc,
    values = ~total_district_complaints_spatial$`Black%`,
    title = "Percent Black residents",
    opacity = 1)

White_perc_m <- m %>%
  addPolygons(
    fillOpacity = 1,
    color = "black",
    opacity = 0.7,
    weight = 1,
    fillColor = ~pal_perc(total_district_complaints_spatial$`White%`))
White_perc_m <- White_perc_m %>%
  addLegend(
    position = "topright",
    pal = pal_perc,
    values = ~total_district_complaints_spatial$`White%`,
    title = "Percent White residents",
    opacity = 1)
 
Latino_perc_m <- m %>%
  addPolygons(
    fillOpacity = 1,
    color = "black",
    opacity = 0.7,
    weight = 1,
    fillColor = ~pal_perc(total_district_complaints_spatial$`Latino%`))
Latino_perc_m <- Latino_perc_m %>%
  addLegend(
    position = "topright",
    pal = pal_perc,
    values = ~total_district_complaints_spatial$`Latino%`,
    title = "Percent Latino residents",
    opacity = 1)

leafsync::sync(Black_perc_m, White_perc_m, Latino_perc_m, ncol = 3, sync = "all")
```

---

# In which neighborhoods are there the most police complaints per capita?

---

# Where are complaints being made?
.pull-left[
- Excluding the first neighborhood, the eight neighborhoods with the most complaints per capita have majority Black residents.
- goes here
]
.pull-right[
```{r data-joins, fig.alt = "Scatterplot of police complaints per capita by district name colored by racial majority. Visualization shows", echo = FALSE, fig.width = 10, out.width = "150%"}
district_complaints <- complaints_accused %>%
  filter(current_unit %in% 1:25) %>%
  group_by(current_unit) %>%
  summarise(n = n()) %>%
  arrange(desc(n))

total_district_complaints <- full_join(district_complaints,
                                       district_demographics,
                                       by = c("current_unit" = "District_No")) %>%
  mutate(complaints_per_capita = n/Population)

total_district_complaints %>%
  filter(is.na(District_Name) == FALSE) %>%
         ggplot(mapping = aes(
                  x = fct_reorder(District_Name, complaints_per_capita),
                  y = complaints_per_capita, 
                color = Majority)) +
  geom_point() +
  geom_segment(aes(x = fct_reorder(District_Name, complaints_per_capita), 
                   xend = fct_reorder(District_Name, complaints_per_capita), 
                   y = 0, yend = complaints_per_capita)) +
  coord_flip() +
  labs(title = "Complaints per Capita by District Name",
       subtitle = "Colored by Racial Majority",
       x = "District Name",
       y = "Complaints Per Capita")
```
  ]
  
---

# Complaints per capita leaflet

```{r complaints-perc-leaflet}
# creating map showing neighborhoods with most missing data ie when the final finding is either NA (missing), NAF (no affidavit) or NC (no affidavit)
#baseline complaints per capita
 
# bins_2 <- seq(from = 0, to = 0.06, by = 0.01)
# pal_per_cap <- colorBin("OrRd", domain = total_district_complaints_spatial, bins = bins_2)
# 
#  complaints_perc_m <- m %>%
#   addPolygons(
#     fillOpacity = 1,
#     color = "black",
#     opacity = 0.7,
#     weight = 1,
#     fillColor = ~pal_per_cap(total_district_complaints_spatial$`complaints_per_capita`))
#       
# complaints_perc_m <- complaints_perc_m %>%
#   addLegend(
#     position = "topright",
#     pal = pal_per_cap,
#     values = ~total_district_complaints_spatial$`complaints_per_capita`,
#     title = "Complaints per capita",
#     opacity = 1)
# 
# complaints_perc_m

```

---
# What happens to the complaints?
.pull-left[- the good news: it's relatively consistent across neighborhoods
- the bad news: nothing is happening to the complaints
]
.pull-right[
```{r proportion-findings-vis}
district_complaints_1 <- complaints_accused %>%
  filter(current_unit %in% 1:25) %>%
  group_by(current_unit)

total_district_complaints_findings <- full_join(district_complaints_1,
                                       district_demographics,
                                       by = c("current_unit" = "District_No"))

#stat = "identity"

data1 <- total_district_complaints_findings %>%
  mutate(final_decision = 
           as.factor(case_when(final_finding %in% "SU" ~ "Sustained",
                               final_finding %in% "DIS" ~ "Sustained",
                               is.na(final_finding) == TRUE ~ "Missing",
                               final_finding %in% "NAF" ~ "No Affidavit or Cooperation",
                               final_finding %in% "NC" ~ "No Affidavit or Cooperation",
                               final_finding %in% "NS" ~ "Not Sustained",
                               final_finding %in% "EX" ~ "Not Sustained",
                               final_finding %in% "UN" ~ "Not Sustained",
                               ))) %>%
  mutate(District_Name = fct_relevel(District_Name,
                                     "Central",
                                     "Englewood",
                                     "Harrison",
                                     "Calumet",
                                     "Grand Crossing",
                                     "Gresham",
                                     "Austin",
                                     "Morgan Park",
                                     "Wentworth",
                                     "Near North",
                                     "South Chicago",
                                     "Ogden",
                                     "Lincoln",
                                     "Near West",
                                     "Chicago Lawn",
                                     "Deering",
                                     "Shakespeare",
                                     "Town Hall",
                                     "Rogers Park",
                                     "Grand Central",
                                     "Albany Park",
                                     "Jefferson Park"
                                     )) %>%
  group_by(final_decision, District_Name)  %>%
  summarize(n = n())

data1 %>%
  group_by(final_decision) %>%
  summarize(n = n())

#reorder so that missing is at the end and change colors, take out the NA
  data1 %>%   
  filter(is.na(District_Name) == FALSE) %>%
  ggplot(aes(fill = factor(final_decision, levels = c("Missing", "Not Sustained", "No Affidavit or Cooperation", "Sustained")),
                           x = fct_relevel(District_Name), district_levels,
                           y = n)) +
  geom_bar(position = "fill", stat = "identity") +
  theme_minimal() +
  scale_fill_viridis_d() +
  coord_flip() +
   labs(title = "Proportion of Final Findings",
        subtitle = "By District",
        x = "District Name",
        y = "Proportion of Complaints",
        fill = "Final Decision"
        ) 

```

```{r some summary stats}
total_district_complaints_findings %>%
  group_by(final_finding) %>%
  summarise(n = n(), perc_of_data = (n/71960)*100)
```
]

# Sustained complaints
.pull-left[
- Some text
- goes here
]
.pull-right[
```{r complaints for sustained decisions, echo = FALSE, warning = FALSE, out.width = "100%"}

sustained_data <- total_district_complaints_findings %>%
  group_by(final_finding, District_Name, Majority, Population) %>%
  filter(final_finding == "SU") %>%
  filter(is.na(District_Name) == FALSE) %>%
  summarize(n = n()) %>%
  mutate(complaints_per_capita = n/Population) 

  ggplot(data = sustained_data, 
                mapping = aes(
                  x = fct_reorder(District_Name, complaints_per_capita),
                  y = complaints_per_capita, 
                color = Majority)) +
  geom_point() +
    geom_segment(aes(x = fct_reorder(District_Name, complaints_per_capita), 
                     xend = fct_reorder(District_Name, complaints_per_capita), 
                   y = 0,
                   yend = complaints_per_capita)) +
  coord_flip() +
  labs(title = " Sustained Complaints per Capita by District Name",
       subtitle = "Colored by Racial Majority",
       x = "District Name",
       y = " Sustained Complaints Per Capita")
```
]

---
# Missing Affidavits

```{r complaints for no cooperation/affidavit decisions}

no_ca_data <- total_district_complaints_findings %>%
  group_by(final_finding, District_Name, Majority, Population) %>%
  filter(final_finding == "NAF") %>%
  filter(is.na(District_Name) == FALSE) %>%
  summarize(n = n()) %>%
  mutate(complaints_per_capita = n/Population) 
  

  ggplot(data = no_ca_data, 
                mapping = aes(
                  x = fct_reorder(District_Name, complaints_per_capita),
                  y = complaints_per_capita, 
                color = Majority)) +
  geom_point() +
    geom_segment(aes(x = fct_reorder(District_Name, complaints_per_capita), 
                     xend = fct_reorder(District_Name, complaints_per_capita), 
                   y = 0,
                   yend = complaints_per_capita)) +
  coord_flip() +
  labs(title = "Complaints Missing Affidavit per Capita by District",
       subtitle = "Colored by Racial Majority",
       x = "District",
       y = "Complaints Missing Affidavit per Capita")
```
